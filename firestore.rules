rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isStaff() {
      return request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'manager' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'employee-a' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'employee-b'
      );
    }
    function isAdminOrManager() {
      return request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'manager'
      );
    }
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // User profiles
    match /users/{userId} {
      // Users can read their own profile. Admins/Managers can read any profile.
      allow read: if isOwner(userId) || isAdminOrManager();
      // Users can update their own profile. Admins/Managers can update any profile (e.g., to change roles).
      allow write: if isOwner(userId) || isAdminOrManager();
    }
    
    // Car listings
    match /cars/{carId} {
      // Anyone can get a single approved car document for the detail page.
      allow get: if resource.data.status == 'approved';
      // Anyone can list approved cars for the homepage/search. Staff can list all.
      allow list: if isStaff() || request.query.filters.size() == 0 || (request.query.filters.size() > 0 && request.query.filters[0][2] == 'approved');
      // Only authenticated users can create car listings.
      allow create: if request.auth != null;
      // Only the user who submitted the listing or an admin/manager can update it.
      allow update: if isOwner(resource.data.submittedBy) || isAdminOrManager();
      // Only an admin/manager can delete a listing.
      allow delete: if isAdminOrManager();
    }

    // Configuration data like filters
    match /config/{docId} {
      // Anyone can read config data (e.g., for filter options).
      allow read: if true;
      // Only Admins/Managers can write config data.
      allow write: if isAdminOrManager();
    }
  }
}
