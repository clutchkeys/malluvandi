
{
  "rules": {
    "rules_version": "2",
    "service cloud.firestore": {
      "match": "/databases/{database}/documents" {
        "function getRole(uid)": "return get(/databases/$(database)/documents/users/$(uid)).data.role;",
        "function isStaff(uid)": "let role = getRole(uid); return role == 'admin' || role == 'manager' || role == 'employee-a' || role == 'employee-b';",
        "function isEmployeeA(uid)": "return getRole(uid) == 'employee-a';",
        "function isEmployeeB(uid)": "return getRole(uid) == 'employee-b';",
        "match": "/users/{userId}" {
          "allow create": "if request.auth != null;",
          "allow read, update": "if request.auth != null && (request.auth.uid == userId || isStaff(request.auth.uid));",
          "allow delete": "if request.auth != null && getRole(request.auth.uid) == 'admin';",
          "allow list": "if request.auth != null && isStaff(request.auth.uid);"
        },
        "match": "/cars/{carId}" {
          "allow get, list": "if resource.data.status == 'approved' || request.auth != null;",
          "allow create": "if request.auth != null;",
          "allow update": "if request.auth != null && (isStaff(request.auth.uid) || (isEmployeeA(request.auth.uid) && resource.data.submittedBy == request.auth.uid));",
          "allow delete": "if request.auth != null && isStaff(request.auth.uid);"
        },
        "match": "/inquiries/{inquiryId}" {
          "allow create": "if request.auth != null;",
          "allow read, update": "if request.auth != null && (resource.data.assignedTo == request.auth.uid || isStaff(request.auth.uid));",
          "allow delete": "if request.auth != null && isStaff(request.auth.uid);",
          "allow list": "if request.auth != null && (isEmployeeB(request.auth.uid) || isStaff(request.auth.uid));"
        },
        "match": "/brands/{brandId}" {
          "allow read, list": "if request.auth != null;",
          "allow write": "if request.auth != null && isStaff(request.auth.uid);"
        },
        "match": "/notifications/{notificationId}" {
          "allow create": "if request.auth != null && isStaff(request.auth.uid);",
          "allow list": "if request.auth != null;",
          "allow read": "if request.auth != null && (resource.data.recipientGroup == 'all' || (resource.data.recipientGroup == 'all-customers' && getRole(request.auth.uid) == 'customer') || (resource.data.recipientGroup == 'all-staff' && isStaff(request.auth.uid)) || resource.data.recipientGroup == getRole(request.auth.uid));",
          "allow delete": "if request.auth != null && isStaff(request.auth.uid);"
        },
        "match": "/config/{docId}" {
          "allow get": "if true;",
          "allow write": "if request.auth != null && (isStaff(request.auth.uid) || isEmployeeA(request.auth.uid));"
        }
      }
    }
  }
}
